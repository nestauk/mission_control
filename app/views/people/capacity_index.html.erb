<% content_for :title, 'Capacity estimates' %>

<div class="bg-teal-800">
  <section class="mx-5 py-4 text-white">
    <h1 class="leading-tight text-xl font-semibold">Capacity estimates</h1>
  </section>
</div>

<div class="flex flex-wrap">
  <aside class="m-5 lg:w-64 w-full">
    <div class="shadow">
      <input type="checkbox" id="filter-toggle">
      <label id="filter-control" for="filter-toggle" class="px-4 py-2 block w-full bg-white">
        <div class="flex justify-between align-items font-semibold">
          Filter
          <%= image_tag 'chevron-down.svg', id: 'chevron-down' %>
        </div>
      </label>

      <div id="filter-body" class="p-4 bg-white rounded-b">
        <%= search_form_for @q, url: capacity_index_people_path do |f| %>
          <%= f.label :members_id_in, 'People', class: 'label' %>
          <%= f.collection_select :memberships_contact_id_in, Contact.all, :id, ->(o) { "#{o.name} (#{o.email})" }, { include_blank: true }, { multiple: true, class: 'input mb-4', data: { controller: "choices" } } %>

          <%= f.label :status_in, 'Status', class: 'label' %>
          <%= f.collection_select :status_in, Project.statuses, :last, ->(o) { o.first.humanize }, { include_blank: true }, { multiple: true, class: 'input mb-4', data: { controller: "choices" } } %>

          <%= f.button 'Filter', type: 'submit', class: "btn text-white bg-blue-800" %>
          <%= link_to 'Reset', capacity_index_people_path, class: 'ml-1 btn bg-blue-200' %>
        <% end %>
      </div>
    </div>
  </aside>

  <div class="m-5 flex-1 lg:w-0 w-full">
    <%# TODO: Alert: This is experimental feature %>
    <%# TODO: handle error cases for params %>
    <%# TODO: colour code values %>
    <%# TODO: sticky table first columns %>
    <%# TODO: refactor out of controller & add tests %>
    <%# TODO: highlight current week %>

    <div class="overflow-auto">
      <table class="impact-table text-sm bg-white">
        <thead>
          <tr class="text-left align-top bg-gray-200 text-gray-700">
            <th class="w-40 bg-gray-200 left-0 sticky">Person</th>
            <%- @weeks.each do |week| %>
              <th class="text-xs"><%= week.strftime("w/o %e %b %y") %></th>
            <% end %>
          </tr>
        </thead>

        <tbody>
          <%- @by_person.each do |person, weeks| %>
            <tr>
              <td class="w-40 bg-gray-100 left-0 sticky">
                <%= link_to person.titleize, person_path(person), class: 'link whitespace-nowrap' %>
              </td>
              <%- weeks.each do |data| %>
                <td>
                  <%= data.select { |i| i['slug'] == person }.sum { |week| week.try(:[], 'avg_time_per_week') || 0 } %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <%# TODO: Only show people rows where there is data %>
    <h2>Per project</h2>

    <div class="overflow-auto">
      <table class="impact-table text-sm bg-white">
        <thead>
          <tr class="text-left align-top bg-gray-200 text-gray-700">
            <th>Project</th>
            <th>Person</th>
            <%- @weeks.each do |week| %>
              <th class="text-xs"><%= week.strftime("w/o %e %b %y") %></th>
            <% end %>
          </tr>
        </thead>

        <tbody>
          <%- @by_project.each do |project, people| %>

            <%- people.sort.each_with_index do |person, i| %>

              <tr>
                <% if i == 0 %>
                  <th rowspan="<%= people.size %>">
                    <%= project %>
                  </th>
                <% end %>
                <td><%= person[0].titleize %></td>
                <%- person[1][0].each do |data| %>
                  <td>
                    <%= data.select { |i| i['title'] == project && i['slug'] == person[0] }[0].try(:[], 'avg_time_per_week') || 0 %>
                  </td>
                <% end %>
              </tr>

            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>

  </div>
</div>
